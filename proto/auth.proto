syntax = "proto3";

package musicclub.auth;

option go_package = "musicclubbot/backend/proto";

import "google/protobuf/empty.proto";
import "permissions.proto";
import "user.proto";

// Authentication and membership gating for the app.
service AuthService {
  // Registers the new user in the system.
  rpc Register(RegisterUserRequest) returns (AuthSession);

  // Logins the user.
  rpc Login(Credentials) returns (AuthSession);

  // Refreshes JWT token pair.
  rpc Refresh(RefreshRequest) returns (TokenPair);

  // Generates Telegram url to link account with telegram.
  rpc GetTgLoginLink(musicclub.user.User) returns (TgLoginLinkResponse);

  // Returns current user profile and permissions for UI gating.
  rpc GetProfile(google.protobuf.Empty) returns (ProfileResponse);
}

message Credentials {
  string username = 1;
  string password = 2;
}

message RegisterUserRequest {
  Credentials credentials = 1;
  musicclub.user.User profile = 2;
}

message RefreshRequest {
  string refresh_token = 1;
}

message TokenPair {
  string access_token = 1;
  string refresh_token = 2;
}

message TgLoginLinkResponse {
  string login_link = 1;
}

message TgLoginRequest {
  musicclub.user.User user = 1;
  // Optional explicit Telegram user id (if provided by the client).
  uint64 tg_user_id = 2;
}

message AuthSession {
  // JWT token pair.
  TokenPair tokens = 1;

  // Token issued-at and expiration (unix seconds).
  uint64 iat = 2;
  uint64 exp = 3;

  // Whether the user is already a member of the music club chat.
  bool is_chat_member = 4;

  // If not a member, link to request manual approval to join the chat.
  string join_request_url = 5;

  // Convenience: current user's profile data.
  musicclub.user.User profile = 6;

  // Permissions snapshot for the session.
  musicclub.permissions.PermissionSet permissions = 7;
}

message ProfileResponse {
  musicclub.user.User profile = 1;
  musicclub.permissions.PermissionSet permissions = 2;
}
